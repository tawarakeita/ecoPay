<!-- 部分テンプレート map_mode.html.erb -->
<div id="custom-map" class="w-full h-[100%]"></div>

<!-- JSON データは隠し div に埋め込む -->
<div id="merchants-data" class="hidden">
  <%= raw(@merchants.to_json(only: [:latitude, :longitude, :name])) %>
</div>

<script>
  function initMap() {
    // マップ初期化
    const map = new google.maps.Map(document.getElementById("custom-map"), {
      center: { lat: 35.658581, lng: 139.745433 },
      zoom: 8
    });

    // merchants データを取得
    const merchantsDiv = document.getElementById("merchants-data");
    if (merchantsDiv) {
      const merchants = JSON.parse(merchantsDiv.textContent);
      if (merchants && merchants.length > 0) {
        merchants.forEach(m => {
          new google.maps.Marker({
            position: { lat: m.latitude, lng: m.longitude },
            map: map,
            title: m.name
          });
        });
      }
    }
  }

  // Turbo 対応
  document.addEventListener("turbo:load", () => {
    if (typeof google !== "undefined" && google.maps) {
      initMap();
    }
  });

  window.initMap = initMap;
</script>

<script async defer src="https://maps.googleapis.com/maps/api/js?key=<%= ENV['MAP_API_KEY'] %>&callback=initMap"></script>